FROM {{ os_name }}:{{ os_version }}

LABEL tailor="bundle"

SHELL ["/bin/bash", "-c"]

ARG AWS_ACCESS_KEY_ID
ENV AWS_ACCESS_KEY_ID ${AWS_ACCESS_KEY_ID}

ARG AWS_SECRET_ACCESS_KEY
ENV AWS_SECRET_ACCESS_KEY ${AWS_SECRET_ACCESS_KEY}

ENV DEBIAN_FRONTEND noninteractive
ENV PYTHONUNBUFFERED 1

RUN apt-get update && apt-get install --no-install-recommends -y locales curl gnupg sudo ccache software-properties-common
RUN locale-gen en_US.UTF-8
ENV LANG en_US.UTF-8

RUN apt-get update && apt-get install --no-install-recommends -y ccache && \
    ccache -M 5G && \
    ccache --set-config=cache_dir=/ccache

# Add locus mirror
RUN apt-get update && apt-get install -y python-all-dev python-pip python-setuptools python-wheel && \
    apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 379CE192D401AB61 && \
    echo "deb http://dl.bintray.com/lucidsoftware/apt/ lucid main" > /etc/apt/sources.list.d/lucidsoftware-bintray.list && \
    apt-get update && apt-get install -y apt-boto-s3

RUN apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 142D5F1683E1528B && \
    echo "deb [arch=amd64] s3://s3.amazonaws.com/tailor-mirror/ubuntu {{ os_version }} hotdog" > /etc/apt/sources.list.d/locus.list && \
    apt-get update && apt-get dist-upgrade -y

# Install build tool
RUN apt-get update && apt-get install --no-install-recommends -y \
    python3-dev \
    python3-pip \
    python3-setuptools \
    python3-wheel \
    git

RUN pip3 install -U \
    pip \
    setuptools

RUN pip3 install \
    catkin-pkg==0.4.8 \
    colcon-cmake==0.2.3 \
    colcon-core==0.3.9 \
    colcon-library-path==0.2.0 \
    colcon-pkg-config==0.1.0 \
    colcon-python-setup-py==0.2.0 \
    colcon-recursive-crawl==0.2.0 \
    # colcon-ros==0.3.2 \
    git+https://github.com/paulbovbel/colcon-ros.git@catkin-env-hooks

# TODO(pbovbel) Get env hook fix fix
RUN pip3 install -U --force-reinstall --no-deps    \

# install build and run dependencies
# TODO(pbovbel) apt doesn't allow installing constrained dependencies, remove regex_replace
RUN apt-get update && apt-get install --no-install-recommends -y \
  {{ build_depends | union(run_depends) | sort | join(' ') | regex_replace('\(.*?\)', '') }}

# Create non-root user
RUN groupadd -r tailor && useradd -ms /bin/bash -g tailor -G sudo tailor
USER tailor

RUN mkdir -p /home/tailor && \
    usermod -d /home/tailor tailor

RUN ccache -M 5G && \
    ccache --set-config=cache_dir=/ccache
